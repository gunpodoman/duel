<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>매점빵 레전드 1ㄷ1</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --p1: #3b82f6; --p2: #ef4444; --accent: #fbbf24; --bg: #020617; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: -apple-system, sans-serif; touch-action: none; color: white; }
        #overlay { position: fixed; inset: 0; background: radial-gradient(circle, #1e293b 0%, #020617 100%); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .card { background: rgba(255,255,255,0.03); padding: 40px; border-radius: 32px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); text-align: center; width: 300px; }
        .btn { width: 100%; padding: 16px; background: var(--accent); border: none; border-radius: 16px; font-weight: 800; font-size: 18px; cursor: pointer; color: #000; box-shadow: 0 0 20px rgba(251,191,36,0.3); }
        .btn:disabled { background: #334155; color: #94a3b8; cursor: wait; }
        #game-ui { display: none; width: 100vw; height: 100vh; position: relative; }
        .hud { position: absolute; top: 0; width: 100%; display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none; }
        .hp-box { background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 15px; width: 140px; border-bottom: 4px solid transparent; }
        .hp-bar { width: 100%; height: 8px; background: #1e293b; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .hp-val { height: 100%; transition: width 0.3s; }
        #msg { position: absolute; top: 120px; width: 100%; text-align: center; font-size: 36px; font-weight: 900; opacity: 0; transition: 0.4s; pointer-events: none; }
        #msg.show { opacity: 1; transform: translateY(10px); }
    </style>
</head>
<body>

<div id="overlay">
    <div class="card">
        <h1 style="margin:0 0 20px 0;">CANNON DUEL</h1>
        <button id="invite-btn" class="btn" onclick="copyLink()" disabled>연결 시도 중...</button>
        <p id="status" style="margin-top:15px; font-size:12px; color:var(--accent);"></p>
    </div>
</div>

<div id="game-ui">
    <canvas id="gameCanvas"></canvas>
    <div class="hud">
        <div class="hp-box" style="border-color:var(--p1)">
            <div style="font-size:10px; opacity:0.6">P1 BLUE</div>
            <div class="hp-bar"><div id="hp1" class="hp-val" style="width:100%; background:var(--p1)"></div></div>
        </div>
        <div id="wind-ui" style="font-weight:900; font-size:14px; background:rgba(0,0,0,0.4); padding:5px 15px; border-radius:20px;">WIND: 0.00 →</div>
        <div class="hp-box" style="border-color:var(--p2); text-align:right">
            <div style="font-size:10px; opacity:0.6">P2 RED</div>
            <div class="hp-bar"><div id="hp2" class="hp-val" style="width:100%; background:var(--p2)"></div></div>
        </div>
    </div>
    <div id="msg">READY</div>
</div>

<script>
    const GRAVITY = 0.25;
    const TANK_SIZE = 35;
    const HIT_RADIUS = 30; // 충돌 판정 범위
    let canvas, ctx, w, h, myId, conn, isHost = false, myNum = 0;
    let explosions = [], particles = [];

    let state = {
        terrain: [],
        p1: { x: 0, y: 0, hp: 100, angle: -0.5 },
        p2: { x: 0, y: 0, hp: 100, angle: 3.6 },
        turn: 1, wind: 0, ball: null, gameOver: false, winner: 0
    };

    // --- 1. 강화된 연결 시스템 (STUN 서버 확충) ---
    const peer = new Peer(null, {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
                { url: 'stun:stun2.l.google.com:19302' },
                { url: 'stun:stun3.l.google.com:19302' },
                { url: 'stun:stun4.l.google.com:19302' }
            ]
        }
    });

    peer.on('open', id => {
        myId = id;
        document.getElementById('invite-btn').disabled = false;
        document.getElementById('invite-btn').innerText = "링크 복사 및 대기";
        if(window.location.hash) connect(window.location.hash.substring(1));
    });

    peer.on('connection', c => {
        conn = c; isHost = true; myNum = 1;
        initDataExchange();
    });

    function connect(tid) {
        conn = peer.connect(tid, { reliable: true });
        isHost = false; myNum = 2;
        initDataExchange();
    }

    function initDataExchange() {
        conn.on('open', () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            initCanvas();
            if(isHost) { createTerrain(); sync(); }
            requestAnimationFrame(loop);
        });
        conn.on('data', data => {
            if(data.type === 'SYNC') {
                state = data.state;
                updateUI();
            }
            if(data.type === 'FIRE') {
                state.ball = { x: data.x, y: data.y, vx: data.vx, vy: data.vy, wind: data.wind };
            }
        });
    }

    function copyLink() {
        const url = `${window.location.origin}${window.location.pathname}#${myId}`;
        navigator.clipboard.writeText(url).then(() => {
            document.getElementById('status').innerText = "링크가 복사되었습니다! 친구에게 공유하세요.";
        });
    }

    // --- 2. 게임 코어 엔진 ---
    function initCanvas() {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        resize(); window.addEventListener('resize', resize);
        setupInput();
    }
    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }

    function createTerrain() {
        state.terrain = [];
        let curH = h * 0.7;
        for(let x = 0; x <= w + 100; x += 50) {
            curH += (Math.random() - 0.5) * 120;
            curH = Math.max(h * 0.4, Math.min(h * 0.85, curH));
            state.terrain.push({x, y: curH});
        }
        state.p1.x = w * 0.15; state.p1.y = getTerrainY(state.p1.x);
        state.p2.x = w * 0.85; state.p2.y = getTerrainY(state.p2.x);
        state.wind = (Math.random() - 0.5) * 0.4;
    }

    function getTerrainY(x) {
        for(let i=0; i<state.terrain.length-1; i++) {
            if(x >= state.terrain[i].x && x <= state.terrain[i+1].x) {
                let r = (x - state.terrain[i].x) / (state.terrain[i+1].x - state.terrain[i].x);
                return state.terrain[i].y * (1-r) + state.terrain[i+1].y * r;
            }
        }
        return h;
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        if(!state.ball || state.gameOver) return;

        const b = state.ball;
        b.vx += b.wind; b.vy += GRAVITY; b.x += b.vx; b.y += b.vy;

        // **개선된 충돌 판정: 비행 중인 탱크 충돌 체크**
        const targetNum = state.turn === 1 ? 2 : 1;
        const target = targetNum === 1 ? state.p1 : state.p2;
        const distToTarget = Math.sqrt((b.x - target.x)**2 + (b.y - (target.y - 15))**2);

        const groundY = getTerrainY(b.x);
        
        // 탱크에 맞거나 땅에 맞았을 때
        if(distToTarget < HIT_RADIUS || b.y > groundY || b.x < 0 || b.x > w) {
            createBoom(b.x, b.y, state.turn === 1 ? '#3b82f6' : '#ef4444');
            
            if(isHost) {
                if(distToTarget < HIT_RADIUS + 10) {
                    target.hp = Math.max(0, target.hp - 34);
                    if(target.hp <= 0) { state.gameOver = true; state.winner = state.turn; }
                }
                state.ball = null;
                if(!state.gameOver) {
                    state.turn = state.turn === 1 ? 2 : 1;
                    state.wind = (Math.random() - 0.5) * 0.4;
                }
                sync();
            } else {
                state.ball = null;
            }
        }
    }

    function sync() { if(isHost) conn.send({type: 'SYNC', state}); updateUI(); }

    function draw() {
        ctx.clearRect(0,0,w,h);
        // 배경 & 지형
        let g = ctx.createLinearGradient(0,0,0,h);
        g.addColorStop(0,'#020617'); g.addColorStop(1,'#1e293b');
        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
        if(state.terrain.length) {
            ctx.beginPath(); ctx.moveTo(0,h);
            state.terrain.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(w,h); ctx.fillStyle = '#0f172a'; ctx.fill();
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; ctx.stroke();
        }
        // 탱크 & 포탄
        drawTank(state.p1, 1); drawTank(state.p2, 2);
        if(state.ball) {
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 15; ctx.shadowColor = '#fff';
            ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, 6, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        }
        // 조준선
        if(input.active && state.turn === myNum && !state.ball) drawGuide();
        // 파티클
        particles.forEach((p,i) => {
            p.x += p.vx; p.y += p.vy; p.a -= 0.02;
            ctx.fillStyle = `rgba(${p.c}, ${p.a})`;
            ctx.fillRect(p.x, p.y, p.s, p.s);
            if(p.a <= 0) particles.splice(i,1);
        });
    }

    function drawTank(p, n) {
        ctx.save(); ctx.translate(p.x, p.y);
        ctx.fillStyle = n === 1 ? '#3b82f6' : '#ef4444';
        ctx.beginPath(); ctx.roundRect(-22, -12, 44, 18, 6); ctx.fill();
        ctx.beginPath(); ctx.arc(0, -12, 12, Math.PI, 0); ctx.fill();
        ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = 8; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(0,-15);
        ctx.lineTo(Math.cos(p.angle)*30, Math.sin(p.angle)*30-15); ctx.stroke();
        ctx.restore();
    }

    function drawGuide() {
        const p = myNum === 1 ? state.p1 : state.p2;
        const dx = input.sx - input.cx, dy = input.sy - input.cy;
        const pwr = Math.min(Math.sqrt(dx*dx+dy*dy)*0.15, 25);
        const ang = Math.atan2(dy, dx);
        ctx.beginPath(); ctx.setLineDash([6,6]); ctx.strokeStyle = 'rgba(255,255,255,0.4)';
        let tx = p.x, ty = p.y-15, tvx = Math.cos(ang)*pwr, tvy = Math.sin(ang)*pwr;
        for(let i=0; i<40; i++) {
            ctx.lineTo(tx, ty); tvx += state.wind; tvy += GRAVITY; tx += tvx; ty += tvy;
        }
        ctx.stroke(); ctx.setLineDash([]);
    }

    function createBoom(x, y, color) {
        const rgb = color === '#3b82f6' ? '59, 130, 246' : '239, 68, 68';
        for(let i=0; i<30; i++) {
            particles.push({ x, y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12, s:Math.random()*6+2, a:1, c:rgb });
        }
    }

    // --- 3. 입력 및 UI ---
    let input = { active:false, sx:0, sy:0, cx:0, cy:0 };
    function setupInput() {
        canvas.addEventListener('pointerdown', e => {
            if(state.turn !== myNum || state.ball || state.gameOver) return;
            input.active = true; input.sx = input.cx = e.clientX; input.sy = input.cy = e.clientY;
        });
        window.addEventListener('pointermove', e => {
            if(!input.active) return;
            input.cx = e.clientX; input.cy = e.clientY;
            const p = myNum === 1 ? state.p1 : state.p2;
            p.angle = Math.atan2(input.sy - input.cy, input.sx - input.cx);
        });
        window.addEventListener('pointerup', () => {
            if(!input.active) return;
            input.active = false;
            const dx = input.sx - input.cx, dy = input.sy - input.cy;
            const pwr = Math.min(Math.sqrt(dx*dx+dy*dy)*0.15, 25);
            const ang = Math.atan2(dy, dx);
            if(pwr > 3) {
                const f = { type:'FIRE', x:(myNum===1?state.p1.x:state.p2.x), y:(myNum===1?state.p1.y:state.p2.y)-15, vx:Math.cos(ang)*pwr, vy:Math.sin(ang)*pwr, wind:state.wind };
                conn.send(f); state.ball = { ...f };
            }
        });
    }

    function updateUI() {
        document.getElementById('hp1').style.width = state.p1.hp + '%';
        document.getElementById('hp2').style.width = state.p2.hp + '%';
        const wnd = state.wind * 100;
        document.getElementById('wind-ui').innerText = `WIND: ${Math.abs(wnd).toFixed(1)} ${wnd>=0?'→':'←'}`;
        const msg = document.getElementById('msg');
        if(state.gameOver) {
            msg.innerText = (state.winner === 1 ? "BLUE" : "RED") + " WINS!";
            msg.style.color = state.winner === 1 ? 'var(--p1)' : 'var(--p2)';
            msg.classList.add('show');
        } else {
            msg.innerText = state.turn === myNum ? "YOUR TURN" : "ENEMY TURN";
            msg.style.color = state.turn === myNum ? 'var(--accent)' : '#fff';
            msg.classList.add('show');
        }
    }
</script>
</body>
</html>
