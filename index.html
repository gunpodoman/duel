<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Core Duel Online</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #1a1a2e; --card-bg: #16213e; --accent: #e94560; --text: #e9e9e9; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; }
        
        #game-container { display: flex; height: 100vh; }
        #board { flex: 1; display: flex; flex-direction: column; justify-content: space-around; padding: 20px; }
        
        /* 필드 레이아웃 */
        .field-row { display: flex; justify-content: center; gap: 20px; height: 150px; }
        .slot { width: 100px; border: 2px dashed #444; border-radius: 10px; position: relative; }
        
        /* 카드 스타일 */
        .card { width: 100px; height: 140px; background: var(--card-bg); border: 2px solid var(--accent); 
                border-radius: 8px; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 12px; }
        .card.opponent { background: #444; }
        .card .atk { position: absolute; bottom: 5px; right: 5px; color: gold; font-weight: bold; }
        .card .cost { position: absolute; top: 5px; left: 5px; color: cyan; font-weight: bold; }

        /* UI 영역 */
        #ui-panel { width: 300px; background: #0f3460; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .status-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; }
        #hand { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        
        button { background: var(--accent); border: none; color: white; padding: 10px; cursor: pointer; border-radius: 5px; }
        button:disabled { background: #555; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="board">
        <div class="field-row" id="opponent-field">
            <div class="slot" data-idx="0"></div>
            <div class="slot" data-idx="1"></div>
            <div class="slot" data-idx="2"></div>
        </div>

        <div style="text-align:center; color: #555;">VS</div>

        <div class="field-row" id="my-field">
            <div class="slot" data-idx="0"></div>
            <div class="slot" data-idx="1"></div>
            <div class="slot" data-idx="2"></div>
        </div>
    </div>

    <div id="ui-panel">
        <div class="status-box">
            <h3>상대 라이프: <span id="opp-hp">10</span></h3>
        </div>
        <div class="status-box">
            <h3>내 정보</h3>
            <p>라이프: <span id="my-hp">10</span></p>
            <p>에너지: <span id="my-energy">1</span></p>
        </div>
        <div id="connection-controls">
            <p>내 ID: <b id="my-id">...</b></p>
            <input type="text" id="opp-id-input" placeholder="상대 ID 입력">
            <button onclick="connectToOpponent()">대전 시작</button>
        </div>
        <div id="game-controls" style="display:none;">
            <p id="turn-display">상대 대기 중...</p>
            <button id="end-turn-btn" onclick="endTurn()">턴 종료</button>
        </div>
        <div id="log" style="font-size: 12px; height: 100px; overflow-y: auto; background: #000; padding: 5px;"></div>
    </div>
</div>

<div id="hand"></div>

<script>
    // 1. 초기 데이터 및 카드 정의
    const cardPool = [
        { id: 1, name: "졸병", atk: 2, cost: 1 },
        { id: 2, name: "기사", atk: 4, cost: 2 },
        { id: 3, name: "드래곤", atk: 7, cost: 3 }
    ];

    let myState = { hp: 10, energy: 1, maxEnergy: 1, hand: [], field: [null, null, null], isMyTurn: false };
    let oppState = { hp: 10, field: [null, null, null] };
    let peer, conn;

    // 2. PeerJS 설정 (온라인 연결)
    peer = new Peer();
    peer.on('open', id => { document.getElementById('my-id').innerText = id; });
    peer.on('connection', c => { setupConnection(c); });

    function connectToOpponent() {
        const targetId = document.getElementById('opp-id-input').value;
        setupConnection(peer.connect(targetId));
    }

    function setupConnection(c) {
        conn = c;
        conn.on('open', () => {
            document.getElementById('connection-controls').style.display = 'none';
            document.getElementById('game-controls').style.display = 'block';
            startGame(conn.initiator);
        });
        conn.on('data', data => handleOpponentAction(data));
    }

    // 3. 게임 로직
    function startGame(isFirst) {
        myState.isMyTurn = isFirst;
        drawCard(3);
        updateUI();
    }

    function drawCard(count) {
        for(let i=0; i<count; i++) {
            const card = cardPool[Math.floor(Math.random()*cardPool.length)];
            myState.hand.push({...card, instId: Date.now() + i});
        }
        updateUI();
    }

    function playCard(instId, slotIdx) {
        if(!myState.isMyTurn) return;
        const cardIdx = myState.hand.findIndex(c => c.instId === instId);
        const card = myState.hand[cardIdx];

        if(myState.energy >= card.cost && !myState.field[slotIdx]) {
            myState.energy -= card.cost;
            myState.field[slotIdx] = card;
            myState.hand.splice(cardIdx, 1);
            sendAction({ type: 'PLAY', card, slotIdx });
            updateUI();
        }
    }

    function endTurn() {
        if(!myState.isMyTurn) return;
        myState.isMyTurn = false;
        myState.maxEnergy = Math.min(myState.maxEnergy + 1, 5);
        sendAction({ type: 'END_TURN', nextEnergy: myState.maxEnergy });
        updateUI();
    }

    // 4. 네트워크 통신
    function sendAction(data) {
        if(conn) conn.send(data);
    }

    function handleOpponentAction(data) {
        if(data.type === 'PLAY') {
            oppState.field[data.slotIdx] = data.card;
            log(`상대가 ${data.card.name} 소환!`);
        } else if(data.type === 'END_TURN') {
            myState.isMyTurn = true;
            myState.energy = data.nextEnergy;
            drawCard(1);
            processBattle(); // 턴 시작 시 자동 전투
            log(`내 턴 시작! (에너지 ${myState.energy})`);
        }
        updateUI();
    }

    // 5. 전투 로직 (간소화: 마주 보는 카드끼리 공격)
    function processBattle() {
        myState.field.forEach((card, i) => {
            if(card) {
                if(oppState.field[i]) {
                    // 몬스터끼리 격돌 (동시 파괴 가정)
                    log(`${card.name}와 상대 ${oppState.field[i].name} 격돌!`);
                    oppState.field[i] = null;
                    myState.field[i] = null;
                } else {
                    // 직접 공격
                    oppState.hp -= card.atk;
                    log(`직접 공격! 상대 HP: ${oppState.hp}`);
                }
            }
        });
        if(oppState.hp <= 0) alert("승리했습니다!");
        sendAction({ type: 'BATTLE_RESULT', myHp: myState.hp, oppHp: oppState.hp });
    }

    // 6. UI 렌더링
    function updateUI() {
        // 내 손패
        const handDiv = document.getElementById('hand');
        handDiv.innerHTML = '';
        myState.hand.forEach(c => {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `<b>${c.name}</b><span class="cost">${c.cost}</span><span class="atk">${c.atk}</span>`;
            el.onclick = () => { 
                const slot = prompt("소환할 슬롯 번호 (0, 1, 2)");
                if(slot !== null) playCard(c.instId, parseInt(slot));
            };
            handDiv.appendChild(el);
        });

        // 필드 렌더링
        renderField('my-field', myState.field, false);
        renderField('opponent-field', oppState.field, true);

        document.getElementById('my-hp').innerText = myState.hp;
        document.getElementById('opp-hp').innerText = oppState.hp;
        document.getElementById('my-energy').innerText = myState.energy;
        document.getElementById('turn-display').innerText = myState.isMyTurn ? "내 턴" : "상대 턴 대기 중...";
        document.getElementById('end-turn-btn').disabled = !myState.isMyTurn;
    }

    function renderField(id, fieldData, isOpp) {
        const slots = document.getElementById(id).children;
        for(let i=0; i<3; i++) {
            slots[i].innerHTML = '';
            if(fieldData[i]) {
                const c = fieldData[i];
                slots[i].innerHTML = `<div class="card ${isOpp?'opponent':''}"><b>${c.name}</b><span class="atk">${c.atk}</span></div>`;
            }
        }
    }

    function log(msg) {
        const l = document.getElementById('log');
        l.innerHTML += `<div>${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }
</script>
</body>
</html>
