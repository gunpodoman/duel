<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Core Artillery Duel</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #87CEEB; --ground: #228B22; --p1: #0000FF; --p2: #FF0000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Arial Black', sans-serif; touch-action: none; }
        
        /* 초대 및 UI 오버레이 */
        #invite-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .btn { padding: 15px 30px; background: #FFD700; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer; color: #000; box-shadow: 0 4px 0 #DAA520; }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        /* 게임 화면 */
        #game-container { width: 100vw; height: 100vh; position: relative; display: none; }
        canvas { display: block; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; display: flex; justify-content: space-between; pointer-events: none; }
        .player-info { background: rgba(255,255,255,0.7); padding: 10px 20px; border-radius: 15px; text-align: center; }
        .hp-bar { width: 150px; height: 20px; background: #555; border-radius: 10px; overflow: hidden; margin-top: 5px; border: 2px solid white; }
        .hp-fill { height: 100%; transition: width 0.3s; }
        #turn-indicator { position: absolute; top: 80px; width: 100%; text-align: center; font-size: 24px; color: white; text-shadow: 2px 2px 4px black; }
    </style>
</head>
<body>

<div id="invite-overlay">
    <h1>CANNON DUEL</h1>
    <p>드래그해서 조준하고 발사하세요!</p>
    <button id="invite-btn" class="btn" onclick="copyInvite()" disabled>링크 생성 중...</button>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div class="player-info" style="color:var(--p1)">
            P1 (Blue)
            <div class="hp-bar"><div id="p1-hp" class="hp-fill" style="width:100%; background:var(--p1)"></div></div>
        </div>
        <div class="player-info" style="color:var(--p2)">
            P2 (Red)
            <div class="hp-bar"><div id="p2-hp" class="hp-fill" style="width:100%; background:var(--p2)"></div></div>
        </div>
    </div>
    <div id="turn-indicator">접속 대기 중...</div>
</div>

<script>
    // === 설정 및 상수 ===
    const GRAVITY = 0.2;
    const MAX_POWER = 25;
    const TANK_SIZE = 30;
    let canvas, ctx, width, height;
    let myId, conn, isHost = false, iAmP1 = false;

    // === 게임 상태 ===
    let gameState = {
        terrain: [], // 지형 높이 배열
        p1: { x: 100, y: 0, hp: 100, color: '#0000FF' },
        p2: { x: 0, y: 0, hp: 100, color: '#FF0000' },
        turn: 1, // 1 or 2
        projectile: null, // 날아가는 포탄 정보
        aiming: null // 조준 정보 {startX, startY, currentX, currentY}
    };

    // === 1. 네트워크 및 초기화 ===
    const peer = new Peer(null, { config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });
    
    peer.on('open', id => {
        myId = id;
        document.getElementById('invite-btn').disabled = false;
        document.getElementById('invite-btn').innerText = "링크 복사 & 게임 시작";
        if(window.location.hash) connectTo(window.location.hash.substring(1));
    });
    peer.on('connection', c => { conn = c; isHost = true; iAmP1 = true; setupConn(); });

    function copyInvite() {
        const url = `${window.location.origin}${window.location.pathname}#${myId}`;
        navigator.clipboard.writeText(url).then(() => alert("링크 복사 완료! 상대가 접속하면 시작합니다."));
    }
    function connectTo(tid) { conn = peer.connect(tid); isHost = false; iAmP1 = false; setupConn(); }

    function setupConn() {
        conn.on('open', () => {
            document.getElementById('invite-overlay').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            initCanvas();
            setupInput();
            if(isHost) initGameHost();
            requestAnimationFrame(gameLoop);
        });
        conn.on('data', data => {
            if(isHost && data.type === 'FIRE') { fire(data.angle, data.power); }
            else if(!isHost && data.type === 'SYNC') { 
                gameState = data.state; 
                updateUI();
            }
        });
    }

    // === 2. 게임 로직 (호스트 중심) ===
    function initCanvas() {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        resize();
        window.addEventListener('resize', resize);
    }
    function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }

    function initGameHost() {
        // 지형 생성 (간단한 사인파 + 노이즈)
        gameState.terrain = [];
        for(let x=0; x<=width; x+=10) {
            const heightMap = Math.sin(x * 0.005) * 100 + Math.sin(x * 0.02) * 30 + height * 0.7;
            gameState.terrain.push({x: x, y: heightMap});
        }
        gameState.p1.y = getTerrainHeight(gameState.p1.x);
        gameState.p2.x = width - 100;
        gameState.p2.y = getTerrainHeight(gameState.p2.x);
        sync();
    }

    function getTerrainHeight(x) {
        for(let i=0; i<gameState.terrain.length-1; i++) {
            if(x >= gameState.terrain[i].x && x <= gameState.terrain[i+1].x) return gameState.terrain[i].y;
        }
        return height;
    }

    function fire(angle, power) {
        if(gameState.projectile) return; // 이미 발사 중이면 무시
        const shooter = gameState.turn === 1 ? gameState.p1 : gameState.p2;
        gameState.projectile = {
            x: shooter.x, y: shooter.y - TANK_SIZE,
            vx: Math.cos(angle) * power, vy: Math.sin(angle) * power,
            radius: 5
        };
        if(isHost) sync();
    }

    function updatePhysics() {
        if(!isHost || !gameState.projectile) return;
        const p = gameState.projectile;
        p.vy += GRAVITY;
        p.x += p.vx; p.y += p.vy;

        // 충돌 체크 (지형 또는 화면 밖)
        const terrainH = getTerrainHeight(p.x);
        if(p.y > terrainH || p.x < 0 || p.x > width) {
            checkHit(p.x, p.y);
            gameState.projectile = null;
            gameState.turn = gameState.turn === 1 ? 2 : 1;
            sync();
        }
    }

    function checkHit(x, y) {
        const target = gameState.turn === 1 ? gameState.p2 : gameState.p1;
        const dist = Math.sqrt((x-target.x)**2 + (y-target.y)**2);
        if(dist < TANK_SIZE + 10) { // 직격 판정 범위
            target.hp = Math.max(0, target.hp - 30); // 데미지 30
            if(target.hp === 0) setTimeout(() => { alert(`Player ${gameState.turn} Wins!`); location.reload(); }, 500);
        }
    }

    function sync() { if(isHost && conn) conn.send({type: 'SYNC', state: gameState}); updateUI(); }

    // === 3. 입력 및 렌더링 ===
    function setupInput() {
        let isAiming = false;
        canvas.addEventListener('pointerdown', e => {
            if(gameState.turn !== (iAmP1 ? 1 : 2) || gameState.projectile) return;
            isAiming = true;
            gameState.aiming = { startX: e.clientX, startY: e.clientY, currentX: e.clientX, currentY: e.clientY };
        });
        canvas.addEventListener('pointermove', e => {
            if(!isAiming) return;
            gameState.aiming.currentX = e.clientX; gameState.aiming.currentY = e.clientY;
        });
        canvas.addEventListener('pointerup', e => {
            if(!isAiming) return;
            isAiming = false;
            const dx = gameState.aiming.startX - gameState.aiming.currentX;
            const dy = gameState.aiming.startY - gameState.aiming.currentY;
            const power = Math.min(Math.sqrt(dx*dx + dy*dy) / 10, MAX_POWER);
            const angle = Math.atan2(dy, dx);
            gameState.aiming = null;
            if(power > 2) { // 너무 약하면 발사 안 함
                if(isHost) fire(angle, power);
                else conn.send({type: 'FIRE', angle: angle, power: power});
            }
        });
    }

    function gameLoop() {
        updatePhysics();
        draw();
        requestAnimationFrame(gameLoop);
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        
        // 지형 그리기
        ctx.fillStyle = '#228B22';
        ctx.beginPath();
        ctx.moveTo(0, height);
        gameState.terrain.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.lineTo(width, height);
        ctx.fill();

        // 플레이어 그리기
        drawTank(gameState.p1);
        drawTank(gameState.p2);

        // 포탄 그리기
        if(gameState.projectile) {
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(gameState.projectile.x, gameState.projectile.y, gameState.projectile.radius, 0, Math.PI*2);
            ctx.fill();
        }

        // 조준선 그리기 (드래그 중일 때)
        if(gameState.aiming && gameState.turn === (iAmP1 ? 1 : 2)) {
            const me = iAmP1 ? gameState.p1 : gameState.p2;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(me.x, me.y - TANK_SIZE);
            const dx = gameState.aiming.startX - gameState.aiming.currentX;
            const dy = gameState.aiming.startY - gameState.aiming.currentY;
            ctx.lineTo(me.x + dx, me.y - TANK_SIZE + dy);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    function drawTank(p) {
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x - TANK_SIZE/2, p.y - TANK_SIZE/2, TANK_SIZE, TANK_SIZE/2); // 몸체
        ctx.beginPath(); ctx.arc(p.x, p.y - TANK_SIZE/2, TANK_SIZE/2, Math.PI, 0); ctx.fill(); // 포탑
    }

    function updateUI() {
        document.getElementById('p1-hp').style.width = gameState.p1.hp + '%';
        document.getElementById('p2-hp').style.width = gameState.p2.hp + '%';
        const turnText = gameState.turn === 1 ? "P1 (Blue) 차례" : "P2 (Red) 차례";
        const myTurn = gameState.turn === (iAmP1 ? 1 : 2);
        document.getElementById('turn-indicator').innerText = myTurn ? "당신의 차례! 드래그해서 발사!" : turnText;
        document.getElementById('turn-indicator').style.color = myTurn ? "yellow" : "white";
    }
</script>
</body>
</html>
