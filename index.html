<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Core Duel: Tactics</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card-atk: #ef4444; --card-def: #3b82f6; --card-sup: #10b981; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        
        #game-ui { display: flex; flex-direction: column; height: 100vh; padding: 10px; }
        #header { display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        
        /* í•„ë“œ ë° ìŠ¬ë¡¯ */
        #field { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 20px; }
        .row { display: flex; justify-content: center; gap: 12px; }
        .slot { width: 85px; height: 115px; border: 2px solid #334155; border-radius: 12px; position: relative; transition: 0.3s; }
        .slot.active { border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }

        /* ì¹´ë“œ ë””ìì¸ ê°•í™” */
        .card { width: 85px; height: 115px; border-radius: 10px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; border: 2px solid #475569; background: #1e293b; transition: 0.2s; }
        .card.selected { transform: translateY(-15px); border-color: white; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .card .type-icon { position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 4px; border-radius: 4px; }
        .card.ATTACKER { border-color: var(--card-atk); }
        .card.GUARDIAN { border-color: var(--card-def); }
        .card.SUPPORTER { border-color: var(--card-sup); }
        .card .stat { position: absolute; bottom: 5px; font-size: 14px; }
        .card .shield-icon { position: absolute; top: 20px; font-size: 20px; color: #3b82f6; opacity: 0.8; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        #hand-area { height: 130px; display: flex; justify-content: center; align-items: flex-end; gap: 8px; padding-bottom: 20px; }
        .btn-turn { position: fixed; right: 20px; bottom: 150px; width: 70px; height: 70px; border-radius: 50%; border: none; background: #f43f5e; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4); }
        .btn-turn:disabled { background: #475569; opacity: 0.5; }

        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input { padding: 12px; border-radius: 8px; border: none; margin: 10px; width: 200px; text-align: center; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 style="letter-spacing: 5px;">CORE DUEL</h1>
    <p>ë‚´ ID: <b id="my-id-display" style="color: #60a5fa;">ë°œê¸‰ ì¤‘...</b></p>
    <input type="text" id="target-id" placeholder="ìƒëŒ€ë°© ID ì…ë ¥">
    <button onclick="connect()" style="padding: 10px 30px; border-radius: 8px; border: none; background: #3b82f6; color: white; font-weight: bold;">ëŒ€ê²° ì‹œì‘</button>
</div>

<div id="game-ui">
    <div id="header">
        <div style="color:var(--card-atk)">ìƒëŒ€ HP: <span id="opp-hp">15</span></div>
        <div id="turn-info">ì ‘ì† ëŒ€ê¸° ì¤‘</div>
        <div style="color:var(--card-def)">ë‚´ HP: <span id="my-hp">15</span></div>
    </div>

    <div id="field">
        <div class="row" id="opp-field">
            <div class="slot"></div><div class="slot"></div><div class="slot"></div>
        </div>
        <div class="row" id="my-field">
            <div class="slot" onclick="deploy(0)"></div>
            <div class="slot" onclick="deploy(1)"></div>
            <div class="slot" onclick="deploy(2)"></div>
        </div>
    </div>

    <div style="text-align:center; font-size:12px; margin-bottom:5px;">
        ENERGY: <span id="energy">1</span> / <span id="max-energy">1</span>
    </div>

    <div id="hand-area"></div>
</div>

<button class="btn-turn" id="turn-btn" onclick="endTurn()" disabled>TURN<br>END</button>

<script>
    // 1. ì¹´ë“œ ë°ì´í„°ë² ì´ìŠ¤ (ë‹¤ì–‘í•œ ëŠ¥ë ¥ì¹˜ì™€ íƒ€ì…)
    const cardDB = [
        { name: "ëŒê²©ë³‘", atk: 3, cost: 1, type: "ATTACKER", desc: "ê³µê²© ìµœì í™”" },
        { name: "ë°©íŒ¨ë³‘", atk: 1, cost: 1, type: "GUARDIAN", shield: true, desc: "1íšŒ ìƒì¡´" },
        { name: "ë³´ê¸‰ë³‘", atk: 1, cost: 1, type: "SUPPORTER", effect: "ENERGY", desc: "+1 ì—ë„ˆì§€" },
        { name: "ê´‘ì „ì‚¬", atk: 5, cost: 2, type: "ATTACKER", desc: "ê°•ë ¥í•œ ì¼ê²©" },
        { name: "ì² ë²½ê¸°ì‚¬", atk: 2, cost: 2, type: "GUARDIAN", shield: true, desc: "ë‹¨ë‹¨í•œ ë°©ì–´" },
        { name: "í•™ì", atk: 1, cost: 2, type: "SUPPORTER", effect: "DRAW", desc: "+1 ë“œë¡œìš°" }
    ];

    let state = {
        myHP: 15, oppHP: 15, energy: 1, maxEnergy: 1,
        myField: [null, null, null], oppField: [null, null, null],
        hand: [], isMyTurn: false, selectedIdx: null
    };

    let peer, conn;

    // 2. ì—°ê²° ë° ì´ˆê¸°í™”
    peer = new Peer();
    peer.on('open', id => document.getElementById('my-id-display').innerText = id);
    peer.on('connection', c => { conn = c; setup(); state.isMyTurn = false; initGame(); });

    function connect() {
        const tid = document.getElementById('target-id').value;
        if(!tid) return;
        conn = peer.connect(tid);
        setup();
        state.isMyTurn = true;
        initGame();
    }

    function setup() {
        conn.on('open', () => document.getElementById('overlay').style.display = 'none');
        conn.on('data', data => {
            if(data.type === 'SYNC') {
                state.oppField = data.field;
                state.oppHP = data.myHP;
                if(data.isTurnEnd) startTurn(data.nextEnergy);
                render();
            }
        });
    }

    // 3. ê²Œì„ ì—”ì§„
    function initGame() {
        for(let i=0; i<3; i++) draw();
        render();
    }

    function draw() {
        if(state.hand.length < 5) {
            const card = cardDB[Math.floor(Math.random()*cardDB.length)];
            state.hand.push({...card, uid: Math.random(), currentShield: card.shield});
        }
    }

    function startTurn(energy) {
        state.isMyTurn = true;
        state.maxEnergy = energy;
        state.energy = energy;
        draw();
        battle(); // í„´ ì‹œì‘ ì‹œ ìë™ ì „íˆ¬
        render();
    }

    function deploy(slotIdx) {
        if(state.selectedIdx === null || state.myField[slotIdx]) return;
        const card = state.hand[state.selectedIdx];
        if(state.energy >= card.cost) {
            state.energy -= card.cost;
            // ì†Œí™˜ ì‹œ ì¦‰ì‹œ íš¨ê³¼
            if(card.effect === "ENERGY") state.energy++;
            if(card.effect === "DRAW") draw();

            state.myField[slotIdx] = card;
            state.hand.splice(state.selectedIdx, 1);
            state.selectedIdx = null;
            sync(false);
            render();
        }
    }

    function battle() {
        state.myField.forEach((myCard, i) => {
            if(!myCard) return;
            const oppCard = state.oppField[i];

            if(oppCard) {
                // ê°€ë””ì–¸ì˜ ë³´í˜¸ë§‰ ë¡œì§
                if(oppCard.currentShield) {
                    oppCard.currentShield = false;
                    state.myField[i] = null; // ê³µê²©ìëŠ” íŒŒê´´
                } else if(myCard.currentShield) {
                    myCard.currentShield = false;
                    state.oppField[i] = null; // ë°©ì–´ì íŒŒê´´
                } else {
                    state.myField[i] = null;
                    state.oppField[i] = null;
                }
            } else {
                state.oppHP -= myCard.atk;
            }
        });
        if(state.oppHP <= 0) alert("ìŠ¹ë¦¬!");
    }

    function endTurn() {
        state.isMyTurn = false;
        sync(true, Math.min(state.maxEnergy + 1, 5));
        render();
    }

    function sync(isTurnEnd, nextEnergy = 0) {
        conn.send({ type: 'SYNC', field: state.myField, myHP: state.myHP, isTurnEnd, nextEnergy });
    }

    // 4. UI ë Œë”ë§
    function render() {
        const handArea = document.getElementById('hand-area');
        handArea.innerHTML = '';
        state.hand.forEach((c, i) => {
            const d = document.createElement('div');
            d.className = `card ${c.type} ${state.selectedIdx === i ? 'selected' : ''}`;
            d.innerHTML = `<span class="type-icon">${c.type}</span><b>${c.name}</b><span class="stat">ATK ${c.atk}</span>`;
            d.onclick = () => { if(state.isMyTurn) state.selectedIdx = (state.selectedIdx === i ? null : i); render(); };
            handArea.appendChild(d);
        });

        renderRow('my-field', state.myField, false);
        renderRow('opp-field', state.oppField, true);

        document.getElementById('my-hp').innerText = state.myHP;
        document.getElementById('opp-hp').innerText = state.oppHP;
        document.getElementById('energy').innerText = state.energy;
        document.getElementById('max-energy').innerText = state.maxEnergy;
        document.getElementById('turn-btn').disabled = !state.isMyTurn;
        document.getElementById('turn-info').innerText = state.isMyTurn ? "MY TURN" : "ENEMY TURN";
        
        document.querySelectorAll('#my-field .slot').forEach((s, i) => {
            s.classList.toggle('active', state.selectedIdx !== null && !state.myField[i]);
        });
    }

    function renderRow(id, data, isOpp) {
        const slots = document.getElementById(id).children;
        for(let i=0; i<3; i++) {
            slots[i].innerHTML = '';
            if(data[i]) {
                const c = data[i];
                slots[i].innerHTML = `
                    <div class="card ${c.type} ${isOpp?'':'me'}">
                        ${c.currentShield ? '<div class="shield-icon">ğŸ›¡ï¸</div>' : ''}
                        <b>${c.name}</b>
                        <span class="stat">${c.atk}</span>
                    </div>`;
            }
        }
    }
</script>
</body>
</html>
